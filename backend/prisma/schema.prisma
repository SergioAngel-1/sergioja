// Prisma Schema for Portfolio Database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

// Profile Information
model Profile {
  id           String   @id @default(cuid())
  name         String
  availability String   @default("available") // available, busy, unavailable
  location     String
  email        String   @unique
  phone        String?
  githubUrl    String?
  linkedinUrl  String?
  twitterUrl   String?
  cvData       String?  @db.Text // PDF file as base64
  cvFileName   String?  // Original filename for display
  cvMimeType   String?  @default("application/pdf") // MIME type
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("profiles")
}

// Projects
model Project {
  id              String    @id @default(cuid())
  slug            String    @unique
  title           String
  longDescriptionEs String?  @db.Text
  longDescriptionEn String?  @db.Text
  images          String[]  @default([]) // Múltiples imágenes del proyecto
  categories      String[]  @default([]) // web, mobile, ai, backend, fullstack - múltiples categorías
  featured        Boolean   @default(false)
  demoUrl         String?
  repoUrl         String?
  githubUrl       String?   // Alias for repoUrl
  isCodePublic    Boolean   @default(true) // Indica si el código fuente es público
  performanceScore Int?
  accessibilityScore Int?
  seoScore        Int?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  publishedAt     DateTime?

  // Relations
  technologies ProjectTechnology[]
  views        ProjectView[]

  @@index([featured]) // Index for featured projects
  @@index([publishedAt(sort: Desc)]) // For sorting by date
  @@index([slug])
  @@map("projects")
}

// Technologies/Skills
model Technology {
  id                String   @id @default(cuid())
  name              String   @unique
  category          String   // frontend, backend, devops, design, other
  proficiency       Int      @default(0) // 0-100
  yearsOfExperience Float    @default(0)
  icon              String?  @db.Text // SVG content (not URL)
  color             String   @default("#FF0000")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  projects ProjectTechnology[]

  @@index([category])
  @@map("technologies")
}

// Many-to-Many relation between Projects and Technologies
model ProjectTechnology {
  projectId         String
  technologyId      String
  category          String   @default("other") // frontend, backend, devops, design, other - específico para este proyecto
  proficiency       Int      @default(50) // 0-100 - nivel de dominio en este proyecto
  yearsOfExperience Float    @default(0) // años de experiencia con esta tech en este proyecto
  createdAt         DateTime @default(now())

  project    Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  technology Technology @relation(fields: [technologyId], references: [id], onDelete: Cascade)

  @@id([projectId, technologyId]) // Composite primary key
  @@index([technologyId]) // For reverse lookups
  @@map("project_technologies")
}

// (TimelineEvent model removed)

// Contact Form Submissions
model ContactSubmission {
  id        String   @id @default(cuid())
  name      String
  email     String
  subject   String
  message   String   @db.Text
  ipAddress String?
  userAgent String?
  status    String   @default("new") // new, read, replied, spam
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("contact_submissions")
}

// Analytics - Project Views
model ProjectView {
  id        String   @id @default(cuid())
  projectId String
  ipAddress String?
  userAgent String?
  referrer  String?
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([createdAt])
  @@map("project_views")
}

// Analytics - Page Views
model PageView {
  id        String   @id @default(cuid())
  path      String
  ipAddress String?
  userAgent String?
  referrer  String?
  createdAt DateTime @default(now())

  @@index([path])
  @@index([createdAt])
  @@map("page_views")
}

// Newsletter Subscriptions
model NewsletterSubscription {
  id        String   @id @default(cuid())
  email     String   @unique
  ipAddress String?
  userAgent String?
  status    String   @default("active") // active, unsubscribed
  source    String   @default("main") // main, portfolio
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([source])
  @@index([isRead])
  @@map("newsletter_subscriptions")
}

// Admin Users
model AdminUser {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  password     String   // bcrypt hash
  role         String   @default("editor") // admin, editor
  isActive     Boolean  @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  refreshTokens RefreshToken[]

  @@index([email])
  @@index([role])
  @@map("admin_users")
}

// Refresh Tokens for JWT authentication
model RefreshToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  // Relations
  user AdminUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// Project Categories - Gestión de categorías de proyectos
model ProjectCategory {
  id          String   @id @default(cuid())
  name        String   @unique // web, mobile, ai, backend, fullstack, etc.
  label       String   // Etiqueta amigable: "Desarrollo Web", "Aplicaciones Móviles"
  description String?
  color       String   @default("#00FF00") // Color para UI
  icon        String?  // Nombre del icono
  order       Int      @default(0) // Orden de visualización
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("project_categories")
}

// Technology Categories - Gestión de categorías de tecnologías
model TechnologyCategory {
  id          String   @id @default(cuid())
  name        String   @unique // frontend, backend, devops, design, database, etc.
  label       String   // Etiqueta amigable: "Frontend", "Backend"
  description String?
  color       String   @default("#00FF00") // Color para UI
  icon        String?  // Nombre del icono
  order       Int      @default(0) // Orden de visualización
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("technology_categories")
}
